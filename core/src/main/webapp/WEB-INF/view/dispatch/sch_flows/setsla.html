<#-- * description: 角色界面 * version: 1.0 *
author:zhilong.deng@hand-china.com * #{copyright}# * --> <#include
"../../include/header.html">
<body>
	<script src="${base.contextPath}/common/language?var=languageData"
		type="text/javascript"></script>
	<div class="container">
		<div class="row clearfix">
			<div class="col-md-12 column">
				<h4><@spring.message 'schflows.setsla'/></h4>
				<div class="form-group">
					<h4 for="name"><@spring.message 'schflows.setalertemail'/></h4>
					<textarea class="form-control" rows="3" id="slaEmails"></textarea>
				</div>
				<table class="table">
					<thead>
						<tr>
							<th><@spring.message 'schflows.slatab.floworjob'/></th>
							<th><@spring.message 'schflows.slatab.slarule'/></th>
							<th><@spring.message 'schflows.slatab.duration'/></th>
							<th><@spring.message 'schflows.slatab.emailaction'/></th>
							<th><@spring.message 'schflows.slatab.kilaction'/></th>
						</tr>
					</thead>
					<tbody id="tbody">

					</tbody>
				</table>
				<button type="button" class="btn btn-default" onclick="addrow()">addRow</button>

			</div>
			<button type="button" style="float: right;" class="btn btn-default"
				onclick="getData()">设置SLA</button>
		</div>
	</div>

	<!-- delete template end -->
	<script type="text/javascript">
	
	var jobs=[];
	function ajax(url) {
		$.ajax({
			url : url,
			type : "GET",
			dataType : "json",
			async:false,
			contentType : "application/json",
			
			success : function(json) {
				jobs=json;
			},
			error : function() {
				
			}
		});
	}
	ajax("${base.contextPath}/schedule/getjoblist?flow_id=${RequestParameters.flowId}&project=${RequestParameters.project}");

	var count=0;
		function addrow() {
			var tr = document.createElement("tr");
			tr.innerHTML = "<td><select class='form-control' id='flow"+count+"'>"
					+ "</select></td><td><select class='form-control'><option value='SUCCESS'>SUCCESS</option><option value='FINISH'>FINISH</option></select></td><td>"
					+ "<input  type='time'>"
					+ "</td><td><input type='checkbox'></td><td><input type='checkbox'></td>";
			document.getElementById("tbody").appendChild(tr);
			var flow=document.getElementById("flow"+count);
			flow.innerHTML+="<option value=''>flow ${RequestParameters.flowId}</option>";

			for(var i=0;i<jobs.length;i++)
				{
				flow.innerHTML+="<option value='"+jobs[i].job_id+"'>job "+jobs[i].job_id+"</option>";
				}   
			
			count++;
		}
		function getData() {
			var sch_id ="${RequestParameters.schId}";
			var slaEmails = $('#slaEmails').val();
			var settings = {};
			var tFlowRules = document.getElementById("tbody");
			for (var row = 0; row < tFlowRules.rows.length; row++) {
				var rFlowRule = tFlowRules.rows[row];
				var id = rFlowRule.cells[0].firstChild.value;
				var rule = rFlowRule.cells[1].firstChild.value;
				var duration = rFlowRule.cells[2].firstChild.value;
				var email = rFlowRule.cells[3].firstChild.checked;
				var kill = rFlowRule.cells[4].firstChild.checked;
				settings[row] = id + "," + rule + "," + duration + "," + email
						+ "," + kill;
			}
			$.ajax({
				url : "${base.contextPath}/schedule/setsla?settings="+settings,
				type : "GET",
				dataType : "json",
				contentType : "application/json",
				data:{scheduleId:sch_id,slaEmails:slaEmails},
				success : function(json) {
					alert(json.message);
					window.close();
				},
				error : function() {
					
				}
			});
		}
	</script>
</body>
</html>
