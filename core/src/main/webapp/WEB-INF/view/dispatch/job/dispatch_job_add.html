<#include "../../include/header.html">
    <body>
    <div>
        <!--曾经出错原因：头部引用相对地址错误-->
        <div id="content-container">
            <div id="theme-content">
                <div class="panel">
                    <form class="form-horizontal">
                        <div class="panel-body col-sm-offset-0">
                            <div class="col-sm-3">
                                <div class="form-group">
                                    <label style="width: 20%">主题</label>
                                    <!--<div class="col-sm-4">-->
                                    <input id="input_themeId" type="text" style="width: 70%" data-bind="value:model.themeId">
                                    <!--</div>-->
                                </div>
                            </div>
                            <div class="col-sm-3">
                                <div class="form-group">
                                    <label style="width: 20%">层次</label>
                                    <!--<div class="col-sm-4">-->
                                    <input id="input_layerId" type="text" style="width:70%" data-bind="value:model.layerId">
                                    <!--</div>-->
                                </div>
                            </div>
                            <div class="col-sm-3">
                                <div class="form-group">
                                    <label style="width: 20%">任务名称</label>
                                    <!--<div class="col-sm-4">-->
                                    <input id="input_layerName" type="text" style="width:70%" data-bind="value:model.jobName" class="k-textbox">
                                    <!--</div>-->
                                </div>
                            </div>
                            <div class="col-sm-3">
                                <div class="form-group">
                                    <span class="btn btn-success" data-bind="click:queryResource" type="submit">查询</span>
                                </div>
                            </div>
                        </div>
                        <!--<div class="panel-footer">-->

                        <!--<div class="col-sm-offset-6">-->
                        <!--<span class="btn btn-success" data-bind="click:queryResource" type="submit">查询</span>-->
                        <!--</div>-->
                        <!--</div>-->
                    </form>
                </div>
                <div id="jobListGrid" style="clear:both"></div>
            </div>
            <div id="details"></div>
        </div>
        <script type="text/javascript">
            $(document).ready(function () {
                var themeBaseUrl = "${base.contextPath}/dispatcher/theme/";
                var layerBaseUrl = "${base.contextPath}/dispatcher/layer/";
                var jobBaseUrl = "${base.contextPath}/dispatcher/job/";

                //声明主窗口
                var viewModel = kendo.observable({
                    model:{themeId:'',layerId:'',jobName:''},
                    queryResource: function(e) {
                        $('#jobListGrid').data('kendoGrid').dataSource.read();
                    }
                });
                var jobs_data = new kendo.data.DataSource({
                    transport: {
                        read:  {
                            url: jobBaseUrl+"query",
                            type : 'GET',
                            dataType: "json"
                        },
                        create: {
                            url: jobBaseUrl+'submit',
                            type : 'POST',
                            dataType: "json",
                            contentType:"application/json"
                        },
                        parameterMap: function(options, operation) {
                            //封装请求参数
                            if (operation !== "read" && options.models) {
                                var datas = options.models;
                                console.log(datas);
                                if(operation =='create' || operation =='update'){
                                    datas = options.models.map(function(data){
                                        data['__status'] = (operation =='create' ? 'add' : 'update');
                                        return data;
                                    });
                                }
                                var data_str = kendo.stringify(datas);
                                jobs_data = data_str;
                                console.log(data_str);
//                        var map = {
//                            jobs_data_array:data_str
//                        };
//                        return map;
                                return data_str;
                            } else if (operation === "read") {
                                var model = viewModel.model;
                                console.log("向服务器发送读取job请求中，themeId,layerId:("+viewModel.model.themeId+","+viewModel.model.layerId+")");
                                if(!model.themeId){
                                    model.themeId='-100';
                                }
                                if(!model.layerId){
                                    model.layerId='-100';
                                }
                                if(!model.jobName){
                                    model.jobName=' ';
                                }

                                var map = {themeId: model.themeId,layerId: model.layerId,jobName:model.jobName};
                                if (options.page)
                                    map.page = options.page;
                                if (options.pageSize)
                                    map.pageSize = options.pageSize;
                                for(var k in map){
                                    if(map[k]==='')delete map[k]
                                }
                                console.log("job查询请求参数:"+map);
                                return map;
                            }
                        }
                    },
                    batch: true,
                    serverPaging : true,
                    pageSize: 5,
                    schema: {
                        data:'rows',
                        total:'total',
                        model: {
                            id: 'jobId',
                            fields: {
                                themeId: { type: 'number',validation: { required: true } },
                                layerId: { type: 'number',validation: { required: true } },
                                jobId: { type: 'number',validation: { required: true } },
                                themeName: { type: 'string',validation: { required: true } },
                                layerName: { type: 'string',validation: { required: true } },
                                jobName: { type: 'string',validation: { required: true } },
                                jobSvn: { type: 'string',validation: { required: true } }
                            }
                        },
                        errors: function(res){
                            if(!res.success && res.message) {
                                return res.message;
                            }
                        }
                    },
                    error: function(e) {
                        alert(e.errors)
                    }
                });
                $("#jobListGrid").kendoGrid({
                    dataSource: jobs_data,
                    resizable: true,
                    selectable: "multiple",
                    scrollable: false,
                    pageable: {
                        pageSizes:[5, 10, 20, 50],
                        refresh:true,
                        buttonCount:5,
                        messages: {
                            noRecords: "未找到任何数据",
                            display: "{0} - {1} 共 {2} 条数据",
                            empty: "没有数据",
                            page: "页",
                            of: "/ {0}",
                            itemsPerPage: "条每页",
                            first: "第一页",
                            previous: "前一页",
                            next: "下一页",
                            last: "最后一页",
                            refresh: "刷新"
                        }
                    },
                    toolbar: [{
                        name:"create",
                        text:'创建'
                    },{
                        name:"save",
                        text:'保存'
                    },{
                        name:"cancel",
                        text:'取消'
                    }
                    ],
                    columns:
                            [
                                { 'field': 'themeId','hidden':true },
                                { 'field': 'layerId','hidden':true },
                                { 'field': 'jobId','hidden':true },
                                { 'field': 'themeName','title':'主题名称', 'width': "100px",'editable':false },
                                { 'field': 'layerName','title':'层次名称', 'width': "100px",'editable':false },
                                { 'field': 'jobName','title':'任务名称', 'width': "100px" },
                                { 'field': 'jobSvn','title':'SVN文件', 'width': "200px" }
                            ],
                    editable: true
                });

                //声明两个查询用的下拉框
                var input_themeId_dataSource = new kendo.data.DataSource({
                    transport: {
                        read: {
                            url: themeBaseUrl+"queryAll",
                            type : 'GET',
                            dataType: "json"
                        },
                        parameterMap: function(options, operation) {
                            if (operation === "read") {
                                var map = {};

                                for(var k in map){
                                    if(map[k]==='')delete map[k]
                                }
                                return map;
                            }
                        }
                    },
                    schema: {
                        data:'rows',
                        model: {
                            id: 'themeId',
                            fields: {
                                themeId: { type: 'number',validation: { required: true } },
                                themeName: { type: 'string',validation: { required: true } }
                            }
                        },
                        errors: function(res){
                            if(!res.success && res.message) {
                                return res.message;
                            }
                        }
                    },
                    error: function(e) {
                        alert(e.errors)
                    }
                });
                $("#input_themeId").kendoDropDownList({
                    dataTextField: "themeName",
                    dataValueField: "themeId",
                    dataSource: input_themeId_dataSource,
                    filter: "startswith",
                    select: onSelect,
                    change: onChange,
                    close: onClose,
                    open: onOpen,
                    filtering: onFiltering,
                    dataBound:onDataBound
                });
                var input_layerId_dataSource =  new kendo.data.DataSource(
                        {
                            transport: {
                                read: {
                                    url: layerBaseUrl+"queryAll",
                                    type : 'GET',
                                    dataType: "json"
                                },
                                parameterMap: function(options, operation) {
                                    console.log("进入第二个下拉框数据加载");
                                    if (operation === "read") {
                                        var map = {};
                                        console.log("第二个下拉框读取到的themeId:"+viewModel.model.themeId);
                                        if(!viewModel.model.themeId){
                                            viewModel.model.themeId='-100';
                                        }
                                        map.themeId=viewModel.model.themeId;
                                        for(var k in map){
                                            if(map[k]==='')delete map[k]
                                        }
                                        return map;
                                    }else{
                                        console.log("layerId:没有进入加载读取数据");
                                    }
                                }
                            },
                            schema: {
                                data:'rows',
                                model: {
                                    id: 'layerId',
                                    fields: {
                                        layerId: { type: 'number',validation: { required: true } },
                                        layerName: { type: 'string',validation: { required: true } }
                                    }
                                },
                                errors: function(res){
                                    if(!res.success && res.message) {
                                        return res.message;
                                    }
                                }
                            },
                            error: function(e) {
                                alert(e.errors)
                            }
                        }
                );
                $("#input_layerId").kendoDropDownList({
                    dataTextField: "layerName",
                    dataValueField: "layerId",
                    dataSource: input_layerId_dataSource,
                    dataBound:onDataBound_2
                });

                //绑定主页面的数据和视图
                kendo.bind($('#theme-content'),viewModel);

                //初始化加载的时候themeId和layerId都默认不设置，
                //并且将在初始化页面之后，点击下拉框加载数据
                console.log("重新设置下拉框的值2");
                input_themeId_dataSource.read();
//                input_layerId_dataSource.read();




                function onOpen() {
                    console.log("event: open");
                };

                function onClose() {
                    console.log("event: close");
                };

                function onChange() {
                    console.log("event: change");
                    viewModel.model.themeId=$("#input_themeId").val();

                    input_layerId_dataSource.read();
                };

                function onSelect(e) {
                    console.log("event: select");
                };

                function onDataBound(e) {
                    console.log("event: DataBound");
                    viewModel.model.themeId=$("#input_themeId").val();
                    console.log("layerId请求url："+input_layerId_dataSource.transport.read.url);
                    input_layerId_dataSource.read();
                };

                function onFiltering(e) {
                    console.log("event: onFiltering");
                }
                function onDataBound_2(e) {
                    viewModel.model.layerId=$("#input_layerId").val();
                }
            });

            //显示层详情页面
            function showDetails(e) {
                e.preventDefault();
                var dataItem = this.dataItem($(e.currentTarget).closest("tr"));
                console.log(dataItem);
                if(!dataItem.themeId || !dataItem.themeName){
                    alert("非法访问");
                    return;
                }
                wnd.content(detailsTemplate(dataItem));
                wnd.center().open();

                loadLayerGrid(dataItem);
            }

            function loadLayerGrid(layerHeaderData) {
                var baseUrl = "${base.contextPath}/dispatcher/layer/";
                console.info(baseUrl);
                var layerViewModel = kendo.observable({
                    model:{
                        themeId:layerHeaderData.themeId
                    }
                });
                var layers_data = new kendo.data.DataSource({
                    transport: {
                        read:  {
                            url: baseUrl+"query",
                            dataType: "json"
                        },
                        create: {
                            url: baseUrl+'submit',
                            type : 'POST',
                            dataType: "json",
                            contentType:"application/json"
                        },
                        parameterMap: function(options, operation) {
                            //封装请求参数
                            if (operation !== "read" && options.models) {
                                var layer_datas = options.models;
                                console.log(layer_datas);
                                if(operation =='create' || operation =='update'){
                                    layer_datas = options.models.map(function(data){
                                        data['__status'] = (operation =='create' ? 'add' : 'update');
                                        return data;
                                    });
                                }
                                console.log("循环输出表格中的数据,开始");
                                for(var k in layer_datas){
                                    layer_datas[k].themeId=layerHeaderData.themeId;
                                    console.log(layer_datas[k]);
                                }
                                console.log("循环输出表格中的数据,结束");
                                var layer_data_str = kendo.stringify(layer_datas);
                                console.log(layer_data_str);
//                        var map = {
//                            layers_data_array:layer_data_str
//                        };
//                        return map;
                                return layer_data_str;
                            } else if (operation === "read") {
                                var layerModel = layerViewModel.model;
                                console.log("层里面的model:"+layerModel);
                                console.log("层里面的themeId:"+layerModel.themeId);
                                if(!layerModel.themeId){
                                    console.log("themeId值没有设置，非法访问");
                                    alert("themeId值没有设置，非法访问");
                                    return;
                                }

                                var map = {themeId: layerModel.themeId};
                                if (options.page)
                                    map.page = options.page;
                                if (options.pageSize)
                                    map.pageSize = options.pageSize;
                                for(var k in map){
                                    if(map[k]==='')delete map[k]
                                }
                                console.log(map);
                                return map;
                            }
                        }
                    },
                    batch: true,
                    serverPaging : true,
                    pageSize: 5,
                    schema: {
                        data:'rows',
                        total:'total',
                        model: {
                            id: 'layerId',
                            fields: {
                                themeId: { type: 'number' },
                                layerName: { type: 'string',validation: { required: true } },
                                layerDescription: { type: 'string',validation: { required: true } },
                                layerSequence: { type: 'number',validation: { required: true } }
                            }
                        },
                        errors: function(res){
                            if(!res.success && res.message) {
                                return res.message;
                            }
                        }
                    },
                    error: function(e) {
                        alert(e.errors)
                    }
                });

                $("#layerListGrid").kendoGrid({
                    dataSource: layers_data,
                    resizable: true,
                    selectable: "multiple",
                    scrollable: false,
                    pageable: {
                        pageSizes:[5, 10, 20, 50],
                        refresh:true,
                        buttonCount:5,
                        messages: {
                            noRecords: "未找到任何数据",
                            display: "{0} - {1} 共 {2} 条数据",
                            empty: "没有数据",
                            page: "页",
                            of: "/ {0}",
                            itemsPerPage: "条每页",
                            first: "第一页",
                            previous: "前一页",
                            next: "下一页",
                            last: "最后一页",
                            refresh: "刷新"
                        }
                    },
                    toolbar: [{
                        name:"create",
                        text:'创建'
                    },{
                        name:"save",
                        text:'保存'
                    },{
                        name:"cancel",
                        text:'取消'
                    }
                    ],
                    columns:
                            [
                                { 'field': 'layerName','title':'层名称', 'width': 70 },
                                { 'field': 'layerDescription','title':'层描述', 'width': 70 },
                                { 'field': 'layerSequence','title':'层描述', 'width': 70 }
                            ],
                    editable: true
                });
                kendo.bind($('#layer-content'),layerViewModel);
            }

        </script>
        <script type="text/x-kendo-template" id="template">
            <div id="details-container">
                <div id="layer-content">
                    <div class="panel panel-primary">
                        <div class="panel-body">
                            <div class="row">
                                <div class="col-md-12">
                                    <div class="col-md-12 col-md-offset-0">
                                        <label class="col-md-5 control-label col-md-offset-0">
                                            主题名称：#= themeName #
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="layerListGrid" style="clear:both">
                    </div>
                </div>
            </div>
        </script>
    </div>
</body>
</html>