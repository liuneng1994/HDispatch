<#-- * description: 角色界面 * version: 1.0 *author:hailin.xu@hand-china.com
* #{copyright}# * --> <#include "../../include/header.html">
<body>
	<script src="../../../../lib/flatpickr.min.js"></script>
	<link rel="stylesheet" type="text/css"
		href="../../../../lib/flatpickr.min.css">
	<script src="${base.contextPath}/common/language?var=languageData"
		type="text/javascript"></script>
	<div id="tipDelete"></div>
	<div id="dialog"></div>
	<div id="content-container">
		<div id="page-content">
			<div class="panel">
				<form class="form-horizontal">
					<div class="panel-body">

						<!-- roleCode -->
						<div class="col-sm-4">
							<div class="form-group">
								<label class="col-sm-4 control-label"><@spring.message
									"hdispatch.flowlist.flowname"/></label>
								<div class="col-sm-6">
									<input type="text" data-bind="value:model.flowName"
										class="k-textbox">
								</div>
							</div>
						</div>
						<!-- roleCode  end-->

						<!--   roleName -->
					
						<!--   roleName  end -->

						<div class="col-sm-4">
							<div class="form-group">
								<label class="col-sm-4 control-label"><@spring.message
									"hdispatch.flowlist.projectname"/></label>
								<div class="col-sm-6">
									<input type="text" data-bind="value:model.projectName"
										class="k-textbox">
								</div>
							</div>
						</div>


						<div class="col-sm-4">
							<div class="form-group">
								<label class="col-sm-4 control-label"><@spring.message
									"hdispatch.flowlist.date"/></label>
								<div class="col-sm-6">
									<input id="picker" data-enable-time="true"
										data-time_24hr="true" data-bind="value:model.date"
										class="k-textbox">
								</div>
							</div>
						</div>
					</div>
					<!--  panel body end -->
					<!-- -  panel-footer -->
					<div class="panel-footer text-right">
						<span class="btn btn-success" data-bind="click:queryResource"
							type="submit"><@spring.message "hap.query"/></span>
					</div>
					<!-- end panel-footer -->
				</form>
			</div>
			<div class="panel">
				<div class="panel-body">
					<div id="toolbar"></div>
					<div id="flowGrid" class="table"></div>
				</div>
			</div>
		</div>
	</div>
	<script src="../../../../lib/dateformat.js"></script>
	<script type="text/javascript">
	console.log(new Date());
	document.getElementById("picker").flatpickr();
		var checkedIds = {};

		//on click of the checkbox:
		function selectRow() {
			var checked = this.checked;
			row = $(this).closest("tr");
			grid = $("#flowGrid").data("kendoGrid");
			dataItem = grid.dataItem(row);
			checkedIds[dataItem.exec_id] = checked;
			if (checked) {
				//-select the row
				row.addClass("k-state-selected");
			} else {
				//-remove selection
				row.removeClass("k-state-selected");
			}

		}

		//on dataBound event restore previous selected rows:
		function onDataBound(e) {
			var view = this.dataSource.view();
			for (var i = 0; i < view.length; i++) {
				if (checkedIds[view[i].id]) {
					this.tbody.find("tr[data-uid='" + view[i].uid + "']")
							.addClass("k-state-selected").find(".checkbox")
							.attr("checked", "checked");
				}
			}
		}

		function flowoperation_ajax(obj, url, succesCallback) {
			$.ajax({
				url : url,
				type : "POST",
				dataType : "json",
				contentType : "application/json",
				data : kendo.stringify(obj),
				success : function(json) {
					if (succesCallback) {
						succesCallback(json);
					}
				},
				error : function() {
					grid.refresh();
				}
			});
		}
		function openFlowDetailPage(flow_id, exec_id) {
			var dialog = $("#dialog").kendoWindow(
					{
						actions : [ "Maximize", "Minimize", "Close" ],
						width : 920,
						height : 450,
						title : flow_id + ' <@spring.message "hdispatch.flowlist.flowdetail"/>',
						visible : false,
						iframe : true,
						content : 'flow_infodetail.html?flow_id=' + flow_id
								+ '&exec_id=' + exec_id
					}).data("kendoWindow");
			dialog.center().open();
		}
		window.stateColor = {
				"PAUSED" : "background-color:#FFCC00;",
				"RUNNING" : "background-color:#00CC00;",
				"SUCCESS" : "background-color:#5CB85C;",
				"FAILED" : "background-color:#D9534F;",
				"BLOCKED" : "background-color:black;",
				"PREPARING" : "background-color:#DDDDDD;"
		};

		$(document)
				.ready(
						function() {

							var viewModel = kendo.observable({
								model : {},
								queryResource : function(e) {
									$('#flowGrid').data('kendoGrid').dataSource
											.read();
								}
							});

							kendo.bind($('#page-content'), viewModel);

							var crudServiceBaseUrl = '${base.contextPath}/flows', dataSource = new kendo.data.DataSource(
									{
										transport : {
											read : {
												url : crudServiceBaseUrl
														+ "/query",
												contentType : "application/json",
												type : "GET"
											},
											parameterMap : function(options,
													type) {
												if (type === "read") {
													
													var model = viewModel.model;
													var map = {};
													if (model.flowName) {
														map.flowName = model.flowName;
													}
													if (model.groupName) {
														map.groupName = model.groupName;
													}
													if (model.projectName) {
														map.projectName = model.projectName;
													}
													if (document.getElementById("picker").value!='') {
														 map.date = new Date(document.getElementById("picker").value).getTime(); 
													}
													if (options.page) {
														map.page = options.page;
													}
													if (options.pageSize) {
														map.pagesize = options.pageSize;
													}
													return map;
												} else {
													var datas = options.models;
													return kendo
															.stringify(datas);
												}
											}
										},
										batch : true,
										serverPaging : true,
										pageSize : 20,
										schema : {
											data : 'rows',
											total : 'total',
											model : {
												id : "exec_id",
												fields : {
													flow_id : {
														type : "string"
													},
													project_name : {
														type : "string"
													},
													group_name : {
														type : "string"
													},
													start_time : {
														type : "long"
													},
													end_time : {
														type : "long"
													},
													elapsed : {
														type : "string"
													},
													status : {
														type : "string"
													},
													running : {
														type : "string"
													}

												}
											},
											errors : function(res) {
												if (!res.success && res.message) {
													return res.message;
												}
											}
										},
										error : function(e) {

										}
									});

							$("#toolbar").kendoToolBar({
								items : [ {
									type : "button",
									id : "start",
									text : '<@spring.message "hap.start"/>'
								}, {
									type : "button",
									id : "pause",
									text : '<@spring.message "hap.pause"/>'
								}, {
									type : "button",
									id : "resume",
									text : '<@spring.message "hap.resume"/>'
								}, {
									type : "button",
									id : "stop",
									text : '<@spring.message "hap.stop"/>'
								} /* , {
																	type : "button",
																	id : "fresh",
																	text : '<@spring.message "hap.fresh"/>'
																} */

								]
							});
							var grid = $("#flowGrid")
									.kendoGrid(
											{
												dataSource : dataSource,
												//width:500,  
												navigatable : true,
												resizable : true,
												reorderable : true,
												scrollable : false,
												editable : false,
												sortable:true,
												pageable : {
													pageSizes : [ 5, 10, 20, 50 ],
													refresh : true,
													buttonCount : 5,
													messages : {
														noRecords : "未找到任何数据",
														display : "{0} - {1} 共 {2} 条数据",
														empty : "没有数据",
														page : "页",
														of : "/ {0}",
														itemsPerPage : "条每页",
														first : "第一页",
														previous : "前一页",
														next : "下一页",
														last : "最后一页",
														refresh : "刷新"
													}
												},
												columns : [
														{
															title : '',
															template : '<input class="checkbox" type="checkbox" />',
															width: 50
														},
														{
															field : "exec_id",
															title : '<@spring.message "hdispatch.flowlist.flowgrid.exeid"/>',
															width : 140
														},
														{
															field : "flow_id",
															title : '<@spring.message "hdispatch.flowlist.flowname"/>',
															width : 80,
															template : function(
																	item) {
																var exec_id = item.exec_id;
																var flow_id = item.flow_id;
																var html = "<a href='javascript:void(0)' style='text-decoration: none;'"
																		+ "onclick='openFlowDetailPage(\""
																		+ flow_id
																		+ "\",\""
																		+ exec_id
																		+ "\")'>"
																		+ flow_id
																		+ "</a>";
																return html;
															}
														},
														{
															field : "project_name",
															title : '<@spring.message "hdispatch.flowlist.projectname"/>',
															width : 200
														},
														
														{
															field : "start_time",
															title : '<@spring.message "hdispatch.flowlist.flowgrid.startdate"/>',
															width : 180,
															template : function(
																	dataItem) {
																var v = dataItem.start_time;
																return v == -1 ? '--'
																		: getFormatDateByLong(
																				v,
																				"yyyy-MM-dd hh:mm:ss");
															}
														},
														{
															field : "end_time",
															title : '<@spring.message "hdispatch.flowlist.flowgrid.enddate"/>',
															width : 180,
															template : function(
																	dataItem) {
																var v = dataItem.end_time;
																/*  
																    if(v instanceof Date){
																        return kendo.toString(v,"yyyy-MM-dd hh:mm:ss");
																    }
																    return v?v:''; */
																return v == -1 ? '--'
																		: getFormatDateByLong(
																				v,
																				"yyyy-MM-dd hh:mm:ss");
															}
														},
														{
															field : "elapsed",
															title : '<@spring.message "hdispatch.flowlist.flowgrid.rundate"/>',
															width : 180,
															template : function(
																	dataItem) {
																var v = dataItem.end_time
																		- dataItem.start_time;
																/*  
																    if(v instanceof Date){
																        return kendo.toString(v,"yyyy-MM-dd hh:mm:ss");
																    }
																    return v?v:''; */
																return v + 'ms';
															}
														},
														{
															field : "status",
															title : '<@spring.message "hdispatch.flowlist.flowgrid.status"/>',
															width : 100,
															template : function(
																	item) {
																if (item.status == 50)
																	status = 'SUCCESS';
																else if (item.status == 70)
																	status = 'FAILED';
																else if (item.status == 20)
																	status = 'PREPARING';
																var html = "<div "
																		+ "style='text-align:center;height:13px;width:80px;text-decoration: none;border-radius:5px;"
																		+ (stateColor[status])
																		+ "' "
																		+ ">"
																		+ item.meaning
																		+ "</div>";
																return html;
															}
														},
														{
															field : "running",
															title : '<@spring.message "hdispatch.flowlist.flowgrid.running"/>',
															width : 100,
															template : function(
																	item) {
																var status = item.running;
																var html = "<div class='progress progress-striped active' style='margin:0;border-radius:5px;'>"
																		+ "<div class='progress-bar progress-bar-success' role='progressbar'"
																		+ "   aria-valuenow='60' aria-valuemin='0' aria-valuemax='100'"
																		+ "  style='width: "
																		+ status
																		+ "%;background-color:#5CB85C; '>"
																		+ " <span class='sr-only'>"
																		+ status
																		+ "% 完成</span></div></div>";
																return html;
															}
														} ]
											}).data("kendoGrid");

							//bind click event to the checkbox
							grid.table.on("click", ".checkbox", selectRow);

							var start = $("#start")
									.kendoButton(
											{
												click : function(e) {
													var checked = [];
													for ( var i in checkedIds) {
														if (checkedIds[i] === true
																&& grid.dataSource
																		.get(i).status == 20)
															checked
																	.push(grid.dataSource
																			.get(
																					i)
																			.toJSON());
													}
													flowoperation_ajax(
															checked,
															'${base.contextPath}/flows/startflow',
															function(json) {
																if (json.code == 1)
																	alert(json.message);
																else if (json.code == 0)
																	alert(json.message);
																else
																	alert("所选流已经启动！");
																grid.refresh();
															});
												}
											}).data("kendoButton");

							var pause = $("#pause")
									.kendoButton(
											{
												click : function(e) {
													var checked = [];
													for ( var i in checkedIds) {
														if (checkedIds[i] === true
																&& grid.dataSource
																		.get(i).status == 20)
															checked
																	.push(grid.dataSource
																			.get(
																					i)
																			.toJSON());
													}
													flowoperation_ajax(
															checked,
															'${base.contextPath}/flows/pauseflow',
															function(json) {
																if (json.code == 1)
																	alert(json.message);
																else if (json.code == 0)
																	alert(json.message);
																else
																	alert("所选流没有在运行中,无法暂停！");
																grid.refresh();
															});
												}
											}).data("kendoButton");

							var stop = $("#stop")
									.kendoButton(
											{
												click : function(e) {
													var checked = [];
													for ( var i in checkedIds) {
														if (checkedIds[i] === true)
															checked
																	.push(grid.dataSource
																			.get(
																					i)
																			.toJSON());
													}
													flowoperation_ajax(
															checked,
															'${base.contextPath}/flows/stopflow',
															function(json) {
																if (json.code == 1)
																	alert(json.message);
																else if (json.code == 0)
																	alert(json.message);
																else
																	alert("所选流没有在运行中,无法停止！");
																grid.refresh();
															});
												}
											}).data("kendoButton");
							var resume = $("#resume")
									.kendoButton(
											{
												click : function(e) {
													var checked = [];
													for ( var i in checkedIds) {
														if (checkedIds[i] === true)
															checked
																	.push(grid.dataSource
																			.get(
																					i)
																			.toJSON());
													}
													flowoperation_ajax(
															checked,
															'${base.contextPath}/flows/resumeflow',
															function(json) {
																if (json.code == 1)
																	alert(json.message);
																else if (json.code == 0)
																	alert(json.message);
																else
																	alert("所选流没有在暂停中,无法恢复！");
																grid.refresh();
															});
												}
											}).data("kendoButton");
							var fresh = $("#fresh")
									.kendoButton(
											{
												click : function(e) {
													var checked = [];
													for ( var i in checkedIds) {
														if (checkedIds[i] === true)
															checked
																	.push(grid.dataSource
																			.get(
																					i)
																			.toJSON());
													}
													flowoperation_ajax(
															checked,
															'${base.contextPath}/flows/freshflow',
															function(json) {
																if (json.code == 1)
																	alert(json.message);
																else if (json.code == 0)
																	alert(json.message);
																else
																	alert("所选流异常！");
																grid.refresh();
															});
												}
											}).data("kendoButton");

						});
	</script>
</body>
</html>
