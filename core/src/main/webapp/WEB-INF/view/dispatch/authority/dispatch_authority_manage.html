<#include "../../include/header.html">
	<#-- * description: 主题组中管理用户权限界面 * version: 1.0 *author:yazheng.yang@hand-china.com
			* #{copyright}# * -->
		<body>
		<div>
			<div id="content-container">
				<div id="theme-content">
					<div id="page-content" style="clear:both">
						<div class="pull-left" id="toolbar-btn" style="padding-bottom:10px;">
							<span class="btn btn-primary k-grid-add" style="float:left;margin-right:5px;" data-bind="click:createFunction"><@spring.message "hap.new"/></span>
                            <span class="btn btn-danger" data-bind="click:batchDeleteFunction" style="float:left;margin-right:5px;"><@spring.message "hdispatch.job.batch_delete"/></span>
                            <span class="btn btn-success k-grid-save-changes"  style="float:left;margin-right:5px;" data-bind="click:saveFunction"><@spring.message "hap.save"/></span>
							<span class="btn btn-default k-grid-cancel-changes" data-bind="click:cancelFunction" style="float:left;margin-right:5px;"><@spring.message "hdispatch.cancel"/></span>
						</div>
						<div class="pull-right" id="query-form" style="padding-bottom:10px;">
							<input type="text"   style="float:left;width:150px;margin-right:5px;" placeholder='<@spring.message "user.username"/>' data-bind="value:model.themeName" class="k-textbox">
							<span class="btn btn-primary" style="float:left;width:70px;margin-right:5px;" data-bind="click:queryFunction" type="submit"><@spring.message "hap.query"/></span>
							<span class="btn btn-default" style="float:left;width:70px"  data-bind="click:resetForm" type="button"><@spring.message "hap.reset"/></span>
							<div style="clear:both"></div>
						</div>
						<div style="clear:both">
							<div id="authorityListGrid" style="clear: both"></div>
						</div>
					</div>
				</div>
				<div id="selectUserDetails"></div>
			</div>
			<script type="text/javascript">
				var wnd, detailsTemplate;
				var baseUrl = "${base.contextPath}/dispatch/themeGroup/authorityUser/";
				var authorities_data;
				var usersToSelect_data;
				//获取传递过来的主题组id和名称
				var themeGroupId = "${RequestParameters.themeGroupId}";
				var themeGroupName = "${RequestParameters.themeGroupName}";
				var viewModel = kendo.observable({
					model : {
						userName:'',
						themeGroupId:themeGroupId
					},
					createFunction: function(){
						$('#authorityListGrid').data('kendoGrid').addRow();
					},
					saveFunction: function(){
						$('#authorityListGrid').data('kendoGrid').dataSource.sync();
					},
					cancelFunction: function(e){
						$('#authorityListGrid').data('kendoGrid').cancelChanges();
					},
					queryFunction: function(e) {
						$('#authorityListGrid').data('kendoGrid').dataSource.page(1);
					},
					resetForm : function(e) {
                        var formData = viewModel.model.toJSON();
                        for ( var k in formData) {
                            if(k==="themeGroupId"){
                                continue;
                            }else {
                                viewModel.model.set(k, null);
                            }
                        }
					},
                    batchDeleteFunction: function (e) {
                        var grid = $("#authorityListGrid").data("kendoGrid");
                        var checked = grid.selectedDataItems();
                        if (grid.selectedDataItems().length) {
                            kendo.ui.showConfirmDialog({
                                title: $l('hap.tip.info'),
                                message: $l('hap.tip.delete_confirm')
                            }).done(function (event) {
                                if (event.button == 'OK') {
                                    $.each(checkedIds, function (key,value) {
                                        if(checkedIds[key])
                                        {
                                            grid.dataSource.remove(grid.dataSource.get(key));
                                            checkedIds[key]=false;
                                        }
                                    });
                                    grid.dataSource.sync();
                                }
                            })
                        }
                    }
				});
                var usersNotInThemeGroup_viewModel;
				kendo.bind($('#query-form'), viewModel);
				kendo.bind($('#toolbar-btn'), viewModel);
				$(document).ready(function () {
					wnd = $("#selectUserDetails")
							.kendoWindow({
								title: '<@spring.message "hdispatch.themeGroup.select"/>',
								modal: true,
								visible: false,
								resizable: true,
                                actions : [ "Maximize", "Minimize", "Close"],
								width: 800,
								height:350
							}).data("kendoWindow");
					detailsTemplate = kendo.template($("#usersNotInThemeGroup_template").html());
					authorities_data = new kendo.data.DataSource({
						transport: {
							read:  {
								url: baseUrl+"queryUnderThemeGroup",
								type : 'GET',
								dataType: "json"
							},
							update: {
								url: baseUrl + "submit_update_delete",
								type : 'POST',
								dataType: "json",
								contentType:"application/json"
							},
							create: {
								url: baseUrl+'submit_update_delete',
								type : 'POST',
								dataType: "json",
								contentType:"application/json"
							},
                            destroy: {
                                url: baseUrl+'submit_update_delete',
                                type : 'POST',
                                dataType: "json",
                                contentType:"application/json"
                            },
							parameterMap: function(options, operation) {
								//封装请求参数
								if (operation !== "read" && options.models) {
									var datas = options.models;
									if(operation =='create'){
										datas = options.models.map(function(data){
											if(data["userId"]){
                                                data['__status'] = 'add';
                                                data['themeGroupId'] = viewModel.model.themeGroupId;
                                                return data;
                                            }
										});
									}
									if(operation =='update'){
										datas = options.models.map(function(data){
											data['__status'] = 'update';
											return data;
										});
									}
                                    if('destroy'==operation){
                                        datas = options.models.map(function(data){
                                            data['__status'] = 'delete';
                                            return data;
                                        });
                                    }
									var data_str = kendo.stringify(datas);
									authorities_data = data_str;
									return data_str;
								} else if (operation === "read") {
									var model = viewModel.model;
									if(!model.userName){
										model.userName='';
									}
									var map = {themeGroupId:model.themeGroupId,userName: model.userName};
									if (options.page)
										map.page = options.page;
									if (options.pageSize)
										map.pageSize = options.pageSize;
									for(var k in map){
										if(map[k]==='')delete map[k]
									}
									return map;
								}
							}
						},
						batch: true,
						serverPaging : true,
						pageSize: 10,
						schema: {
							data:'rows',
							total:'total',
							model: {
								id: 'authorityId',
								fields: {
									userName: {
										type: 'string',
                                        validation: { required: true, nullable: false }
									},
                                    themeGroupId: { type: 'number' },
                                    userId: { type: 'number' },
                                    authRead: { type: 'string' },
                                    authOperate: { type: 'string' }
								}
							},
							errors: function(res){
								if(!res.success && res.message) {
									return res.message;
								}
							}
						},
						error: function(e){
							if(e.errors){
								alert(e.errors);
							}else {
								var responseText = eval("("+e.xhr.responseText+")");
								if(!responseText.success && responseText.message){
									alert(responseText.message);
								}
							}
						}
					});

                    $("#authorityListGrid").kendoGrid({
						dataSource: authorities_data,
						resizable: true,
						selectable: "multiple",
						scrollable: true,
						pageable: {
							pageSizes:[10, 20, 50, 100],
							refresh:true,
							buttonCount:10,
							messages: {
								noRecords: '<@spring.message "hdispatch.grid_find_no_data"/>',
								display: '{0} - {1} <@spring.message "hdispatch.grid_data_total_num"/> {2} <@spring.message "hdispatch.grid_data_records"/>',
								empty: '<@spring.message "hdispatch.grid_find_no_data"/>',
								page: '<@spring.message "hdispatch.grid_page"/>',
								of: "/ {0}",
								itemsPerPage: '<@spring.message "hdispatch.grid_pages_per_page"/>',
								first: '<@spring.message "hdispatch.grid_first_page"/>',
								previous: '<@spring.message "hdispatch.grid_pre_page"/>',
								next: '<@spring.message "hdispatch.grid_next_page"/>',
								last: '<@spring.message "hdispatch.grid_last_page"/>',
								refresh: '<@spring.message "hdispatch.grid_refresh"/>'
							}
						},
						columns:
								[
                                    {
                                        title: '',
                                        template: '<input class="checkbox" type="checkbox"/>',
                                        width: '12px',
                                        headerAttributes: {style: "text-align:center"},
                                        attributes: {style: "text-align:center"}
                                    },
									{
										'field': 'authorityId','hidden':true
									},
									{
										'field': 'userId','hidden':true
									},
									{
									    'field': "userName",
										'title': '<@spring.message "user.username"/>',
										'width': "100px",
										editor:userSelector,
										template:"#=userName#"
									},
                                    {
                                        title: '读权限',
                                        'field':'authRead',
                                        width: "40px",
                                        headerAttributes: {style: "text-align:center"},
                                        attributes: {style: "text-align:center"},
                                        template: function (rowData) {
                                            if("N"==rowData.authRead){
                                                return  '<input type="checkbox" class="gridCheckbox_authRead" id="authRead"  name="authRead"/>';
                                            }else {
												rowData.set("authRead","Y");
                                                return '<input type="checkbox" class="gridCheckbox_authRead" checked="checked" id="authRead"  name="authRead"/>';
                                            }
                                        }
                                    },
                                    {
                                        title: '操作权限',
                                        'field':'authOperate',
                                        width: "40px",
                                        headerAttributes: {style: "text-align:center"},
                                        attributes: {style: "text-align:center"},
                                        template: function (rowData) {
                                            if("Y"==rowData.authOperate){
                                                return '<input type="checkbox" class="gridCheckbox_authOperate" checked="checked" id="authOperate"  name="authOperate"/>';
                                            }else {
												rowData.set("authOperate","N");
                                                return  '<input type="checkbox" class="gridCheckbox_authOperate" id="authOperate"  name="authOperate"/>'
                                            }
                                        }
                                    }
								],
						editable: true,
						edit:function (e) {
							//current row data: e.model
							if(!e.model.authorityId){
								$("#grid_search_btn").on("click",function(){
                                    grid_button_click(e.model);
                                });
//                                $("#grid_search_btn.k-input.k-textbox").attr("readonly","readonly");
							}

//							$("#grid_search_btn").attr("onclick","grid_button_click()");
						}
					});
					kendo.bind($('#theme-content'),viewModel);
				});

				function userSelector(container, options) {
					$('<span class="k-textbox k-space-right" style="width: 100%;"><input readonly="readonly" type="text" name="' + options.field + '" class="k-input k-textbox"/><a href="#" id="grid_search_btn" class="k-icon k-i-search">&nbsp;</a></span>')
							.appendTo(container);
				}

				function grid_button_click(rowData) {
					//打开LOV窗口
					//监听双击事件，回写
//					rowData.set("themeName","测试。。。");
                    showDetailLov(rowData);
				}

				function showDetailLov(rowData) {
                    wnd.content(detailsTemplate);
                    wnd.center().open();
                    usersNotInThemeGroup_viewModel = kendo.observable({
                        model : {
                            userName:'',
                            themeGroupId:themeGroupId
                        },
                        queryFunction: function(e) {
                            $('#usersNotInThemeGroup_grid').data('kendoGrid').dataSource.page(1);
                        },
                        resetForm : function(e) {
                            var formData = usersNotInThemeGroup_viewModel.model.toJSON();
                            for ( var k in formData) {
                                if(k==="themeGroupId"){
                                    continue;
                                }else {
                                    usersNotInThemeGroup_viewModel.model.set(k, null);
                                }
                            }
                        }
                    });
                    usersToSelect_data = new kendo.data.DataSource({
                        transport: {
                            read:  {
                                url: baseUrl+"queryNotInThemeGroup",
                                type : 'GET',
                                dataType: "json"
                            },
                            parameterMap: function(options, operation) {
                                //封装请求参数
                                if (operation === "read") {
                                    var model = usersNotInThemeGroup_viewModel.model;
                                    if(!model.userName){
                                        model.userName='';
                                    }
                                    var map = {themeGroupId:model.themeGroupId,userName: model.userName};
                                    if (options.page)
                                        map.page = options.page;
                                    if (options.pageSize)
                                        map.pageSize = options.pageSize;
                                    for(var k in map){
                                        if(map[k]==='')delete map[k]
                                    }
                                    return map;
                                }
                            }
                        },
                        batch: true,
                        serverPaging : true,
                        pageSize: 10,
                        schema: {
                            data:'rows',
                            total:'total',
                            model: {
                                id: 'userId',
                                fields: {
                                    userName: {
                                        type: 'string'
                                    }
                                }
                            },
							errors: function(res){
								if(!res.success && res.message) {
									return res.message;
								}
							}
						},
						error: function(e){
							if(e.errors){
								alert(e.errors);
							}else {
								var responseText = eval("("+e.xhr.responseText+")");
								if(!responseText.success && responseText.message){
									alert(responseText.message);
								}
							}
						}
                    });
                    $("#usersNotInThemeGroup_grid").kendoGrid({
                        dataSource: usersToSelect_data,
                        resizable: true,
                        selectable: "multiple",
                        scrollable: true,
                        pageable: {
                            pageSizes:[10, 20, 50, 100],
                            refresh:true,
                            buttonCount:10,
                            messages: {
                                noRecords: '<@spring.message "hdispatch.grid_find_no_data"/>',
                                display: '{0} - {1} <@spring.message "hdispatch.grid_data_total_num"/> {2} <@spring.message "hdispatch.grid_data_records"/>',
                                empty: '<@spring.message "hdispatch.grid_find_no_data"/>',
                                page: '<@spring.message "hdispatch.grid_page"/>',
                                of: "/ {0}",
                                itemsPerPage: '<@spring.message "hdispatch.grid_pages_per_page"/>',
                                first: '<@spring.message "hdispatch.grid_first_page"/>',
                                previous: '<@spring.message "hdispatch.grid_pre_page"/>',
                                next: '<@spring.message "hdispatch.grid_next_page"/>',
                                last: '<@spring.message "hdispatch.grid_last_page"/>',
                                refresh: '<@spring.message "hdispatch.grid_refresh"/>'
                            }
                        },
                        columns:
                                [
                                    {
                                        'field': 'userId','hidden':true
                                    },
                                    {
                                        'field': 'userName',
                                        'title':'<@spring.message "user.username"/>',
                                        'width': "100px"
                                    }
                                ],
                        editable: false
                    });
                    $("#usersNotInThemeGroup_grid").on("dblclick", "tr", function (e) {
                        e.preventDefault();
                        var firstRow = $("#usersNotInThemeGroup_grid").data("kendoGrid").selectedDataItems()[0];
                        rowData.set("userId",firstRow.userId);
                        rowData.set("userName",firstRow.userName);
                        console.log("("+firstRow.userId+","+firstRow.userName+")");
                        wnd.close();
                    });
                    kendo.bind($('#selectTheme-content'),usersNotInThemeGroup_viewModel);
                }

                //checkbox event
                $("#authorityListGrid").on("change", "input.gridCheckbox_authRead", function (e) {
                    var target = $(e.target), grid = $("#authorityListGrid").data("kendoGrid"),
                            dataItem = grid.dataItem(target.closest("tr"));
                    dataItem.set(target.context.name, this.checked ? 'Y' : 'N');
                });
                $("#authorityListGrid").on("change", "input.gridCheckbox_authOperate", function (e) {
                    var target = $(e.target), grid = $("#authorityListGrid").data("kendoGrid"),
                            dataItem = grid.dataItem(target.closest("tr"));
                    dataItem.set(target.context.name, this.checked ? 'Y' : 'N');
                });
                $("#authorityListGrid").on("click", ".checkbox" , selectRow);
                //只用采用这种方式才能避免checkbox选中，但是读取数据时却没有被传递到后台
                var checkedIds = {};
                function selectRow() {
                    var checked = this.checked,
                            row = $(this).closest("tr"),
                            grid = $("#authorityListGrid").data("kendoGrid"),
                            dataItem = grid.dataItem(row);

                    checkedIds[dataItem.authorityId] = checked;
                    if (checked) {
                        row.addClass("k-state-selected");
                    } else {
                        row.removeClass("k-state-selected");
                    }
                }

			</script>
			<script type="text/x-kendo-template" id="usersNotInThemeGroup_template">
				<div id="details-container">
					<div id="selectTheme-content">
                        <div class="pull-right" id="themesNotInThemeGroup_form" style="padding-bottom:10px;">
                            <input type="text"   style="float:left;width:150px;margin-right:5px;" placeholder='<@spring.message "user.username"/>' data-bind="value:model.userName" class="k-textbox">
                            <span class="btn btn-primary" style="float:left;width:70px;margin-right:5px;" data-bind="click:queryFunction" type="submit"><@spring.message "hap.query"/></span>
                            <span class="btn btn-default" style="float:left;width:70px"  data-bind="click:resetForm" type="button"><@spring.message "hap.reset"/></span>
                            <div style="clear:both"></div>
                        </div>
                        <div style="clear:both">
                            <div id="usersNotInThemeGroup_grid" style="clear: both"></div>
                        </div>
					</div>
				</div>
			</script>
		</div>
		</body>
</html>