<#-- 
 * description: 角色界面
 * version: 1.0 
 * author:hailin.xu@hand-china.com 
 * #{copyright}# 
 * --> 
<#include "../include/header.html">
<body>
   <script src="${base.contextPath}/common/language?var=languageData" type="text/javascript"></script>
   <div id="window"></div> 
	<div id="content-container">
		<div id="page-content">
			<div class="panel">
				<form class="form-horizontal" id="myForm">
					<div class="panel-body">

						<!-- roleCode -->
						<div class="col-sm-4">
							<div class="form-group">
								<label class="col-sm-3 control-label"><@spring.message "prompt.promptcode"/></label>
								<div class="col-sm-8">
									<input type="text" data-bind="value:model.promptCode"
										class="k-textbox" >
								</div>
							</div>
						</div>
						<!-- roleCode  end-->

						<!--   roleName -->
						<div class="col-sm-4">
							<div class="form-group">
								<label class="col-sm-3 control-label"><@spring.message "prompt.sourcelang"/></label>
								<div class="col-sm-8">
								     <select  data-role="combobox" data-text-field="description" data-value-field="langCode" data-bind="source: resourceTypeData,value:model.lang"></select>
								</div>
							</div>
						</div>
						<!--   roleName  end -->



						<div class="col-sm-4">
							<div class="form-group">
								<label class="col-sm-3  control-label"><@spring.message "prompt.description"/></label>
								<div class="col-sm-8">
									<input type="text" data-bind="value:model.description"
										class="k-textbox" >
								</div>
							</div>
						</div>

					</div>
					<!--  panel body end -->
					<!-- -  panel-footer -->

					<div class="panel-footer text-right">
						<span class="btn btn-success" data-bind="click:queryResource"
							type="submit"><@spring.message "hap.query"/></span>
					    <input class="btn btn-primary" 
							type="button" data-bind="click:reset" value='<@spring.message "hap.reset"/>'/>
					</div>
					<!-- end panel-footer -->
				</form>
			</div>
			<div class="panel">
				<div class="panel-body">

					<div id="promptGrid" class="table"></div>
				</div>
			</div>
		</div>
	</div>

	<!-- delete template -->
	<script type="text/x-kendo-template" id="windowTemplate">
       <div> 
          <div class="deleteMessage">
           <span>are you sure delete <strong>#= promptCode #</strong>?</span>
           </div>
        <div class="deleteButton">
            <button class="k-button" id="yesButton">Yes</button>
            <button class="k-button" id="noButton"> No</button>
        </div> 
       </div>
    </script>
	<!-- delete template end -->

	<script type="text/javascript">
	   function formReset()
	   {
		   //window.location.reload();
		   
	       $("#myForm").reset();
	      
	       
	   }
        
        $(document).ready(function () {
           
          var windowTemplate = kendo.template($("#windowTemplate").html());
          var window = $("#window").kendoWindow({
               title: "delete",
               visible: false, //the window will not appear before its .open method is called
               width: "250px",
               height: "100px"
     
          }).data("kendoWindow");	
          
    	  var viewModel = kendo.observable({
              model:{},
              resourceTypeData:languageData,
              queryResource: function(e) {
                  $('#promptGrid').data('kendoGrid').dataSource.read();
              },
              reset:function(){
            	  debugger;
            	  formReset();            	 
                  var model = viewModel.model;
 
                  if(model.promptCode)
            	  {
            		  model.promptCode=null;
            	  }
            	  if(model.lang)
             	 {
             		  model.lang=null;
             	 }
            	  if(model.description)
             	 {
             		  model.description=null;
             	 } 
              }
          });

    	   kendo.bind($('#page-content'),viewModel);  
    	  
          var crudServiceBaseUrl ="${base.contextPath}/sys/prompt",
              dataSource = new kendo.data.DataSource({
                  transport: {
                     read:  {
                        url: crudServiceBaseUrl + "/query",
                        type : "POST",
                        dataType: "json"
                    },
                    create : { 
                        url : crudServiceBaseUrl + "/submit",
                        contentType: "application/json",
                        type : "POST" 
                    },
                    update : { 
                        url : crudServiceBaseUrl + "/submit",
                        contentType: "application/json",
                        type : "POST" 
                    },
                    destroy : { 
                        url : crudServiceBaseUrl + "/remove",
                        contentType: "application/json",
                        type : "POST" 
                    },
                    parameterMap: function(options, type) {
                        if (type !== "read" && options.models) {
                            var datas = options.models
                            if(type =='create' || type =='update'){
                                datas = options.models.map(function(data){
                                    data['__status'] = (type =='create' ? 'add' : 'update');
                                    return data;
                                })
                            }
                            return kendo.stringify(datas);
                        } else if (type === "read") {
                            var model = viewModel.model;
                            var map = {};
                            if(model.promptCode)
                           {
                             	 map.promptCode=model.promptCode;
                           }
                            if(model.lang)
                            {
                            	map.lang=model.lang.langCode;
                            }
                            if(model.description)
                            {
                            	map.description=model.description;
                            }
                            if (options.page) 
                               {
                            	 map.page = options.page; 
                               }
                            if (options.pageSize) 
                              {
                                map.pagesize = options.pageSize;
                              }
                            return map;
                        }  
                    }
                },
                batch: true,
                serverPaging : true,
                pageSize: 20,
                schema: {
                    data:'rows',
                    total:'total',
                    model: {
                        id: "promptCode",
                        fields: {
                             lang: {validation: { required: true }},
                             description: { validation: { required: true } ,type:"string" }
                        }
                    },
                    errors: function(res){
                        if(!res.success && res.message) {
                            return res.message;
                        }
                    }
                },
                error: function(e) {
                    alert(e.errors)
                }
            }); 
    
     var grid =$("#promptGrid").kendoGrid({
            dataSource: dataSource,
            //width:500,
            navigatable: true,
            resizable: true,
            scrollable: false,
            pageable:{
                pageSizes:[5, 10, 20, 50],
                refresh:true,
                buttonCount:5,
                messages: {
                    noRecords: "未找到任何数据",
                    display: "{0} - {1} 共 {2} 条数据",
                    empty: "没有数据",
                    page: "页",
                    of: "/ {0}",
                    itemsPerPage: "条每页",
                    first: "第一页",
                    previous: "前一页",
                    next: "下一页",
                    last: "最后一页",
                    refresh: "刷新"
                }
            },
            toolbar: [{ 
                     name:"create", 
                     text:'<@spring.message "hap.new"/>'
             },{
                     name:"save",
                     text:'<@spring.message "hap.save"/>'  
     
                 },{
                     name:"cancel",
                     text:'<@spring.message "hap.cancel"/>'
                 }
                 ],
            columns: [
                { field: "promptCode", title: '<@spring.message "prompt.promptcode"/>', width: 240 },
                { field: "lang", title: '<@spring.message "prompt.sourcelang"/>', width: 120, template: function(dataItem){
                    var v = dataItem.lang;
                    $.each(languageData,function(i,n){
                        if((n.langCode||'').toLowerCase() == (v||'').toLowerCase()){
                            v = n.description;
                            return false;
                        }
                    })
                    return v;
                }, editor: function(container, options){
                    $('<input required name="' + options.field + '"/>')
                    .appendTo(container)
                    .kendoDropDownList({
                        dataTextField: "description",
                        dataValueField: "langCode",
                        dataSource: languageData
                    });
                }},
                { field: "description", title: '<@spring.message "prompt.description"/>', width: 120},
                {attributes: {style: "text-align:center"}, command : [{

                     text : '<@spring.message "hap.delete"/>',
                  /* tempate: '<span class="btn btn-success"><@spring.message "hap.delete"/></span>',*/
                     click: function(e){
                	   e.preventDefault(); //prevent page scroll reset
                       var tr = $(e.target).closest("tr"); //get the row for deletion
                       var data = this.dataItem(tr); //get the row data so it can be referred later
                       window.content(windowTemplate(data)); //send the row data object to the template and render it
                       window.center().open();

                       $("#yesButton").click(function(){
                           grid.dataSource.remove(data)  //prepare a "destroy" request
                           grid.dataSource.sync()  //actually send the request (might be ommited if the autoSync option is enabled in the dataSource)
                           window.close();
                       });
                       
                       $("#noButton").click(function(){
                           window.close();
                       });
                    } 
                }],width:70}
                ],
           editable: true
        }).data("kendoGrid"); 
        
    }); 
</script>
<style type="text/css">
  .deleteButton{
   
  }
  #yesButton{
      position:absolute; 
      top:50px; 
      left:50px;
      width:50px;
  }
  #noButton{
      position:absolute; 
      top:50px; 
      right:50px;
      width:50px;
  }
  .deleteMessage{
       position:absolute; 
       left:50px;
  }
</style>
</body>
</html>
