<#--
 * description: 配置维护界面
 * version: 1.0 
 * author:qingliang.zeng@hand-china.com
 *  
 * 
-->
<#include "../include/header.html">
<body >
    <div id="content-container">
        <div id="page-content">
            <div class="panel" style="padding:0px;">
                <form class="form-horizontal">
                    <div class="panel-body">
                           	<div class="col-sm-6">
                                <div class="form-group">
                                    <label class="col-sm-3 control-label"><@spring.message "profile.profilename"/></label>
                                    <div class="col-sm-9">
                                        <input type="text" style="width:100%"  data-bind="value:model.profileName" class="k-textbox">
                                    </div>
                                </div>
                            </div>
                            <div class="col-sm-6">
                                <div class="form-group">
                                    <label class="col-sm-3 control-label"><@spring.message "profile.description"/></label>
                                    <div class="col-sm-9">
                                        <input type="text" style="width:100%"  data-bind="value:model.description" class="k-textbox">
                                    </div>
                                </div>
                            </div>
                    </div>
                    <div class="panel-footer text-right">
                       <span class="btn btn-success" data-bind="click:queryResource" type="submit"><@spring.message "hap.query"/></span>
                    </div>
                </form>
            </div>
            <div id="Grid" style="clear:both" class="table"></div>
        </div>
    </div>
 <!-- 自定义的 编辑，新建 弹框 使用该 window  -->
 <div id="mywindow"></div>   
<script type="text/javascript">

$(document).ready(function () {
	
	    var viewModel = kendo.observable({
	        model:{},
	        queryResource: function(e) {
	            $('#Grid').data('kendoGrid').dataSource.read();
	        }
	    });
	    kendo.bind($('#page-content'),viewModel)
	    
        var BaseUrl = "${base.contextPath}/sys/profile/",
            dataSource = new kendo.data.DataSource({
                transport: {
                    read:  {
                        url: BaseUrl + "query",
                        type : "POST",
                        dataType: "json"
                    },
                    update: {
                        url: BaseUrl + "submit",
                        type : "POST" ,
                        contentType: "application/json"
                    },
                    destroy: {
                        url: BaseUrl + "remove",
                        type : "POST" ,
                        contentType: "application/json"
                    },
                    create: {
                        url: BaseUrl + "submit",
                        type : "POST" ,
                        contentType: "application/json"
                    },
                    parameterMap: function(options, type) {
                        if (type !== "read" && options.models) {
                            var datas = options.models
                            if(type =='create' || type =='update'){
                                datas = options.models.map(function(data){
                                    data['__status'] = (type =='create' ? 'add' : 'update');
                                    return data;
                                })
                            }
                            return kendo.stringify(datas);
                        } else if (type === "read") {
                            var model = viewModel.model;
                            var map = {profileName: model.profileName,description: model.description}
                            if (options.page) 
                                map.page = options.page; 
                            if (options.pageSize) 
                                map.pagesize = options.pageSize;
                            for(var k in map){
                            	if(map[k]==='')delete map[k]
                            }
                            return map;
                        }  
                    }
                },
                batch: true,
                serverPaging : true,
                pageSize: 10,
                schema: {
                    data:'rows',
                    total:'total',
                    model: {
                    	id: "profileId",
                        fields: {
                        	profileName: { validation: { required: true  } },
                        	description: { validation: { required: false } }
                        }
                    },
                    errors: function(res){
                        if(!res.success && res.message) {
                            return res.message;
                        }
                    }
                },
                error: function(e) {
                    alert(e.errors)
                }
            });


        $("#Grid").kendoGrid({
        	dataSource: dataSource,
            resizable: true,
            scrollable: false,
            pageable: {
                pageSizes:[5, 10, 20, 50],
                refresh:true,
                buttonCount:5,
                messages: {
                    noRecords: "未找到任何数据",
                    display: "{0} - {1} 共 {2} 条数据",
                    empty: "没有数据",
                    page: "页",
                    of: "/ {0}",
                    itemsPerPage: "条每页",
                    first: "第一页",
                    previous: "前一页",
                    next: "下一页",
                    last: "最后一页",
                    refresh: "刷新"
                }
            },
            toolbar: [{ 
                name:"create", 
                text:'<@spring.message "hap.new"/>'
            },{
                name:"save",
                text:'<@spring.message "hap.save"/>'
            },{
                name:"cancel",
                text:'<@spring.message "hap.cancel"/>'
       		}],
            columns: [
                { 
                	field: "profileName", 
                	title: '<@spring.message "profile.profilename"/>',
                	width: 120 
                }, { 
                	field: "description", 
                	title: '<@spring.message "profile.description"/>',
                	width: 120 
                },
                {attributes: {style: "text-align:center"}, command : [{
                    text : '<@spring.message "hap.delete"/>',
                    click: function(e){
                        e.preventDefault();
                        var source = $("#Grid").data('kendoGrid').dataSource,
                        data = this.dataItem($(e.target).closest("tr"));
                        source.remove(data)
                        source.sync()
                    }
                },{
                	text : '<@spring.message "hap.edit"/>',
                	click: function(e){
                        e.preventDefault();
                        var source = $("#Grid").data('kendoGrid').dataSource,
                        data = this.dataItem($(e.target).closest("tr"));
                        
                        var mywindow =  $("#mywindow").kendoWindow({
                        	actions: [ "Maximize", "Minimize", "Close"],
                            width: 800,
                            height: 400,
                            title: '<@spring.message "hap.edit"/>', 
                            visible: false,
                            iframe: true,
                            content: 'sys_profile_edit_kendoui.html?isedit=1&profileId='+data.profileId                   
                        }).data("kendoWindow");
                        
                        mywindow.center().open();
                    }
                }],  width : 70} ],
                editable: true
        });
        
    });

</script>
</body>
</html>
