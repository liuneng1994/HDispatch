<#--
 * description: 配置维护界面
 * version: 1.0 
 * author:qingliang.zeng@hand-china.com
 *  
 * 
-->
<#include "../include/header.html">
<script src="${base.contextPath}/common/code?profileLevelData=SYS.PROFILE_LEVEL_ID" type="text/javascript"></script>
<body style="padding: 10px;">
 <div id="content-container">
        <div id="page-content">
            <div class="panel" style="padding:0px;">
                <form id="mainform"  class="form-horizontal" method="post" enctype="application/json;charset=UTF-8">
                    <div class="panel-body">
                            <div class="col-sm-6">
                                <div class="form-group">
                                    <label class="col-sm-4 control-label"><@spring.message "profile.profilename"/></label>
                                    <div class="col-sm-8">
                                    	<input type="hidden" name="profileId"  data-bind="value:model.profileId" class="k-textbox">
                                        <input type="text" style="width:100%" name="profileName"  data-bind="value:model.profileName" class="k-textbox">
                                    </div>
                                </div>
                            </div>
                            <div class="col-sm-6">
                                <div class="form-group">
                                    <label class="col-sm-4 control-label"><@spring.message "profile.description"/></label>
                                    <div class="col-sm-8">
                                        <input type="text" style="width:100%" name="description" data-bind="value:model.description" class="k-textbox">
                                    </div>
                                </div>
                            </div>
                    </div>
                    <div id="Grid" style="clear:both" class="table"></div>
                    <div class="panel-footer text-right">
                     	  <!-- 提交 暂时  有问题  即 不能 成功 保存 --> 
                          <button class="btn btn-success"  type="submit"><@spring.message "hap.submit"/></button>
                    </div>
                </form>
            </div>
        </div>     
 </div>
 <!--我这里是 加载 window_level_kendoui.html 页面到 该 window -->
 <div id="levelWindow"></div>   
<script type="text/javascript">

$(document).ready(function () {
	
	 //   <#assign isedit = (RequestParameters.isedit!'0')/>  
	//    <#assign profileId = (RequestParameters.profileId!'0')/>     
  
		

    var viewModel = kendo.observable({
        model:{}
    });
    
    if('${RequestParameters.isedit!0}'=='1'){
    	$.ajax({
    		url: "${base.contextPath}/sys/profile/query?profileId=${RequestParameters.profileId!}",
    		success:function(args){
    			var profile = args.rows[0]||{};
    			for(var i in profile){
    				viewModel.set("model."+i,profile[i]);		
    			}
    		}
    	});
    }
    kendo.bind($('#page-content'),viewModel)
    
    var mainform = $("#mainform");
    mainform.attr("action", "${base.contextPath}/sys/profile/submit");
	
    var BaseUrl = "${base.contextPath}/sys/profilevalue/";
            dataSource = new kendo.data.DataSource({
                transport: {
                    read:  {
                        url: BaseUrl + "query?profileId=${RequestParameters.profileId!}",
                        type : "POST",
                        dataType: "json"
                    },
                    destroy: {
                        url: BaseUrl + "remove",
                        type : "POST" ,
                        contentType: "application/json"
                    },
                    parameterMap: function(options, type) {
                        if (type !== "read" && options.models) {
                            var datas = options.models
                            if(type =='create' || type =='update'){
                                datas = options.models.map(function(data){
                                    data['__status'] = (type =='create' ? 'add' : 'update');
                                    return data;
                                })
                            }
                            return kendo.stringify(datas);
                        }  
                    }
                },
                batch: true,
                serverPaging : true,
                pageSize: 5,
                schema: {
                    data:'rows',
                    total:'total',
                    model: {
                    	id: "profileValueId",
                        fields: {
                        	levelName: { validation: { required: false } },
                        	levelValue: { validation: { required: true  } },
                        	profileValue: { validation: { required: true  } }
                        }
                    },
                    errors: function(res){
                        if(!res.success && res.message) {
                            return res.message;
                        }
                    }
                },
                error: function(e) {
                    alert(e.errors)
                }
            });

		var  myLevelId;        
        $("#Grid").kendoGrid({
        	dataSource: dataSource,
            resizable: false,
            scrollable: false,
            navigatable: true,
            pageable: {
                pageSizes:[5, 10],
                refresh:true,
                buttonCount:5,
                messages: {
                    noRecords: "未找到任何数据",
                    display: "{0} - {1} 共 {2} 条数据",
                    empty: "没有数据",
                    page: "页",
                    of: "/ {0}",
                    itemsPerPage: "条每页",
                    first: "第一页",
                    previous: "前一页",
                    next: "下一页",
                    last: "最后一页",
                    refresh: "刷新"
                }
            },
            toolbar: [{ 
                name:"create", 
                text:'<@spring.message "hap.new"/>'
            },{
                name:"cancel",
                text:'<@spring.message "hap.cancel"/>'
       		}],
            columns: [
			    { field: "levelId", title: '<@spring.message "profilevalue.levelid"/>', width: 120, template: function(dataItem){
			    	var v;
			    	if (typeof(dataItem.levelId) == "object"){
			    		var mean=dataItem.levelId.meaning;
			    		//debugger;
			    		$.each(profileLevelData,function(i,temp){
                            if(temp.meaning==mean){
                            	dataItem.levelId = temp.value;
                            }
                        })
			    	}
			    	v = dataItem.levelId;
                    //取出 下拉框的值 暂存到  变量 myLevelId 中 
                    myLevelId = v;
                    if(v>0){
                    	$.each(profileLevelData,function(i,temp){
                            if(temp.value==v){
                                v = temp.meaning;
                                return v;
                            }
                        })
                    }
                    return v;
                }, editor: function(container, options){
                    $('<input required name="' + options.field + '"/>')
                    .appendTo(container)
                    .kendoDropDownList({
                        dataTextField: "meaning",
                        dataValueField: "value",
                        dataSource: profileLevelData
                    });
                }},{ 
                	field: "levelName", 
                	title: '<@spring.message "profilevalue.levelvalue"/>',
                	width: 120,
                	editor:function(){
                		 //alert("myLevelId==>" + myLevelId);
                		
                	     var window =  $("#levelWindow").kendoWindow({
                         	actions: [ "Maximize", "Minimize", "Close"],
                             width: 500,
                             height: 300,
                             title: '<@spring.message "hap.tip.info"/>', 
                             visible: false,
                             iframe: true,  
                             //此处 若用 此种 window 做lv,传递的值   需要 动态 监听 下拉框的 value 
                             content: 'window_level_kendoui.html?levelId='+myLevelId  
                         }).data("kendoWindow");
                         window.center().open();
                	}
                },{ 
                	field: "profileValue", 
                	title: '<@spring.message "profilevalue.profilevalue"/>',
                	width: 120 
                },  {attributes: {style: "text-align:center"}, command : [{
                    text : '<@spring.message "hap.delete"/>',
                    click: function(e){
                        e.preventDefault();
                        var source = $("#Grid").data('kendoGrid').dataSource,
                        data = this.dataItem($(e.target).closest("tr"));
                        source.remove(data)
                        source.sync()
                    }
                }],  width : 70}],
                editable: true
        });
        
  
        
    });

</script>
</body>
</html>
